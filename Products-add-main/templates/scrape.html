{% extends "base.html" %}

{% block title %}Scrape - Shopify Automation{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Web Scraper</h1>
    <p>Extract products from any e-commerce website using AI-powered crawling</p>
</div>

<div class="alert alert-info" style="max-width: 900px; margin: 0 auto 32px auto;">
    <strong>How it works:</strong> Our two-step process first crawls and extracts products with AI, then lets you review and push selected items to your Shopify store.
</div>

<!-- Main Scrape Form -->
<div class="card" style="max-width: 900px; margin: 0 auto;">
    <h2 class="card-title">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: var(--color-primary);">
            <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
            <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
            <line x1="12" y1="22.08" x2="12" y2="12"></line>
        </svg>
        Configure Crawl Settings
    </h2>

    <form id="scrapeForm">
        <div class="form-group">
            <label for="websiteUrl">Website URL</label>
            <input
                type="text"
                id="websiteUrl"
                name="url"
                placeholder="https://example-store.com"
                required
            >
            <small>Enter the URL of any e-commerce website (Shopify, WooCommerce, Magento, custom stores, etc.)</small>
        </div>

        <div class="form-group">
            <label for="maxPages">Maximum Pages to Crawl (These are number of Pages not Products).</label>
            <input
                type="number"
                id="maxPages"
                name="max_pages"
                placeholder="50"
                min="1"
                max="15000"
                value="10000"
            >
            <small>Higher numbers capture more products but take longer to process.</small>
        </div>

        <button type="submit" class="btn btn-primary" id="submitBtn" style="width: 100%; padding: 14px; font-size: 15px;">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
            </svg>
            Start Crawling
        </button>
    </form>

    <div id="loader" class="loader" style="display: none;"></div>
    <div id="status" style="display: none; margin-top: 24px;"></div>
</div>

<!-- Info Sections -->
<div style="max-width: 900px; margin: 40px auto; display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
    <div class="card">
        <h3 style="font-size: 18px; font-weight: 700; margin-bottom: 16px; color: var(--color-text-primary); display: flex; align-items: center; gap: 8px;">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: var(--color-primary);">
                <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
            </svg>
            Process Overview
        </h3>
        <ol style="line-height: 2; color: var(--color-text-secondary); padding-left: 20px; font-size: 14px;">
            <li>Intelligent crawling of website pages</li>
            <li>AI-powered product identification</li>
            <li>Automated data extraction and formatting</li>
            <li>Structured storage in database</li>
            <li>Manual review and selection</li>
            <li>One-click push to Shopify</li>
        </ol>
    </div>

    <div class="card">
        <h3 style="font-size: 18px; font-weight: 700; margin-bottom: 16px; color: var(--color-text-primary); display: flex; align-items: center; gap: 8px;">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: var(--color-success);">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                <polyline points="22 4 12 14.01 9 11.01"></polyline>
            </svg>
            Key Features
        </h3>
        <ul style="line-height: 2; color: var(--color-text-secondary); padding-left: 20px; font-size: 14px;">
            <li>Universal compatibility with any platform</li>
            <li>OpenAI-powered data extraction</li>
            <li>Automatic format conversion</li>
            <li>Variant and image handling</li>
            <li>Quality control workflow</li>
            <li>Shopify-ready output</li>
        </ul>
    </div>

    <div class="card">
        <h3 style="font-size: 18px; font-weight: 700; margin-bottom: 16px; color: var(--color-text-primary); display: flex; align-items: center; gap: 8px;">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: var(--color-warning);">
                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                <line x1="12" y1="9" x2="12" y2="13"></line>
                <line x1="12" y1="17" x2="12.01" y2="17"></line>
            </svg>
            Important Notes
        </h3>
        <ul style="line-height: 2; color: var(--color-text-secondary); padding-left: 20px; font-size: 14px;">
            <li>Processing time varies by site size</li>
            <li>Review products before pushing</li>
            <li>Check extracted data accuracy</li>
            <li>Respect source website terms</li>
            <li>Monitor crawl progress in dashboard</li>
            <li>Large sites may take several minutes</li>
        </ul>
    </div>
</div>

<!-- Technical Details -->
<div class="card" style="max-width: 900px; margin: 0 auto; background: var(--color-bg); border: none;">
    <h3 style="font-size: 18px; font-weight: 700; margin-bottom: 16px; color: var(--color-text-primary);">Technical Specifications</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 24px; font-size: 14px;">
        <div>
            <div style="color: var(--color-text-secondary); margin-bottom: 4px;">Crawling Engine</div>
            <div style="font-weight: 600;">Firecrawl API</div>
        </div>
        <div>
            <div style="color: var(--color-text-secondary); margin-bottom: 4px;">AI Model</div>
            <div style="font-weight: 600;">OpenAI GPT</div>
        </div>
        <div>
            <div style="color: var(--color-text-secondary); margin-bottom: 4px;">Output Format</div>
            <div style="font-weight: 600;">Shopify Compatible</div>
        </div>
        <div>
            <div style="color: var(--color-text-secondary); margin-bottom: 4px;">Processing</div>
            <div style="font-weight: 600;">Asynchronous</div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    document.getElementById('scrapeForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const submitBtn = document.getElementById('submitBtn');
        const loader = document.getElementById('loader');
        const status = document.getElementById('status');
        const url = document.getElementById('websiteUrl').value.trim();
        const maxPages = parseInt(document.getElementById('maxPages').value) || 50;

        // Validation
        if (!url.startsWith('http://') && !url.startsWith('https://')) {
            status.style.display = 'block';
            status.className = 'alert alert-error';
            status.innerHTML = '<strong>Invalid URL:</strong> Please enter a valid URL starting with http:// or https://';
            return;
        }

        submitBtn.disabled = true;
        submitBtn.innerHTML = `
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation: spin 1s linear infinite;">
                <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
            </svg>
            Processing...
        `;
        loader.style.display = 'block';
        status.style.display = 'none';

        try {
            const response = await fetch('/api/scrape-firecrawl', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    url,
                    max_pages: maxPages
                })
            });

            const data = await response.json();

            loader.style.display = 'none';
            status.style.display = 'block';

            if (response.ok) {
                status.className = 'alert alert-success';
                status.innerHTML = `
                    <div style="display: flex; align-items: start; gap: 12px;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="flex-shrink: 0; color: var(--color-success); margin-top: 2px;">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                            <polyline points="22 4 12 14.01 9 11.01"></polyline>
                        </svg>
                        <div>
                            <strong style="display: block; margin-bottom: 8px;">Crawl Started Successfully</strong>
                            <div style="margin-bottom: 4px;"><strong>Task ID:</strong> ${data.task_id}</div>
                            <div style="margin-bottom: 12px;"><strong>Job ID:</strong> ${data.job_id}</div>
                            <div style="color: var(--color-text-secondary); margin-bottom: 16px;">
                                ${data.message} This process may take a few minutes depending on the site size.
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <a href="/" class="btn btn-secondary">View Dashboard</a>
                                <a href="/products?job_id=${data.job_id}" class="btn btn-primary">View Products</a>
                            </div>
                        </div>
                    </div>
                `;

                // Clear form
                document.getElementById('scrapeForm').reset();
                document.getElementById('maxPages').value = 50;
            } else {
                status.className = 'alert alert-error';
                status.innerHTML = `
                    <div style="display: flex; align-items: start; gap: 12px;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="flex-shrink: 0; color: var(--color-danger); margin-top: 2px;">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="15" y1="9" x2="9" y2="15"></line>
                            <line x1="9" y1="9" x2="15" y2="15"></line>
                        </svg>
                        <div>
                            <strong style="display: block; margin-bottom: 8px;">Crawl Failed</strong>
                            <div>${data.error || 'An unexpected error occurred. Please try again.'}</div>
                        </div>
                    </div>
                `;
            }
        } catch (error) {
            loader.style.display = 'none';
            status.style.display = 'block';
            status.className = 'alert alert-error';
            status.innerHTML = `
                <div style="display: flex; align-items: start; gap: 12px;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="flex-shrink: 0; color: var(--color-danger); margin-top: 2px;">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="15" y1="9" x2="9" y2="15"></line>
                        <line x1="9" y1="9" x2="15" y2="15"></line>
                    </svg>
                    <div>
                        <strong style="display: block; margin-bottom: 8px;">Connection Error</strong>
                        <div>${error.message}</div>
                    </div>
                </div>
            `;
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = `
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
                </svg>
                Start Crawling
            `;
        }
    });
</script>
<style>
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
</style>
{% endblock %}
